<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</title>

  <!-- Firebase (modular v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

  <style>
    body{font-family:system-ui,Arial;padding:24px;background:#fafafa}
    .card{max-width:420px;margin:0 auto 24px;background:#fff;padding:20px;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.08)}
    h2{margin:0 0 14px}
    input{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;margin:8px 0}
    button{width:100%;padding:12px;border:0;border-radius:12px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .primary{background:#2563eb;color:#fff}
    .secondary{background:#f3f4f6}
    .muted{color:#666;font-size:12px}
    #msg{margin-top:8px;min-height:20px;color:#e11d48}
    .ok{color:#059669}
  </style>
</head>
<body>

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙŠÙˆØ²Ø± + ÙƒÙ„Ù…Ø© Ø³Ø± -->
  <div class="card">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input id="loginUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
    <input id="loginPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button class="primary" onclick="loginByUsername()">Ø¯Ø®ÙˆÙ„</button>
    <div class="muted" style="margin-top:8px">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØªÙ… Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· (Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø­ÙÙˆØ¸ Ù„Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹)</div>
  </div>

  <!-- Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ -->
  <div class="card">
    <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <input id="signupUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
    <input id="signupEmail" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Gmail)" />
    <input id="signupPassword" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button class="secondary" onclick="signup()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
  </div>

  <!-- Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
  <div class="card">
    <h2>Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</h2>
    <input id="resetEmail" type="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ (Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø¶ÙŠ Ù„Ùˆ ØªØ°ÙƒØ± Ø§Ù„ÙŠÙˆØ²Ø± ÙÙ‚Ø·)" />
    <input id="resetUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ùˆ Ù†Ø³ÙŠØª Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)" />
    <button onclick="resetPassword()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†</button>
    <div class="muted" style="margin-top:8px">Ø³ÙŠØ±Ø³Ù„ Firebase Ø±Ø§Ø¨Ø·/ÙƒÙˆØ¯ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø¬Ù„</div>
  </div>

  <div id="msg"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { 
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    sendPasswordResetEmail 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { 
    getFirestore, collection, doc, setDoc, query, where, getDocs, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ØªÙ‡ÙŠØ¦Ø© Firebase Ø¨Ù…Ø´Ø±ÙˆØ¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyBz4UTRffkD9kUH_KoDYP_tHbFfqu2opuA",
    authDomain: "moqtada-wasafi.firebaseapp.com",
    projectId: "moqtada-wasafi",
    storageBucket: "moqtada-wasafi.firebasestorage.app",
    messagingSenderId: "405020759603",
    appId: "1:405020759603:web:19fefdf22c7cc46865b546",
    measurementId: "G-DFKCXSX6G1"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const $ = (id) => document.getElementById(id);
  const setMsg = (t, ok=false) => {
    const el = $("msg");
    el.textContent = t;
    el.className = ok ? "ok" : "";
  };

  // ğŸ” Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨: Username + Email + Password (ÙŠØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙŠÙˆØ²Ø± ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…)
  window.signup = async function () {
    const username = $("signupUsername").value.trim();
    const email    = $("signupEmail").value.trim();
    const password = $("signupPassword").value;

    if (!username || !email || !password) return setMsg("Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„.");

    try {
      // ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙƒØ±Ø±
      const q = query(collection(db, "users"), where("username", "==", username));
      const snap = await getDocs(q);
      if (!snap.empty) return setMsg("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ØŒ Ø¬Ø±Ù‘Ø¨ Ø§Ø³Ù… Ø¢Ø®Ø±.");

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Auth
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      const uid  = cred.user.uid;

      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore ØªØ­Øª users/{uid}
      await setDoc(doc(db, "users", uid), {
        username, email, createdAt: serverTimestamp()
      });

      setMsg("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…ØŒ ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„...", true);
      setTimeout(()=>{ window.location.href = "services.html"; }, 900);
    } catch (e) {
      setMsg(e.message || "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨.");
    }
  };

  // ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙŠÙˆØ²Ø± + ÙƒÙ„Ù…Ø© Ø³Ø± (Ù†Ø¬ÙŠØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ù† Firestore)
  window.loginByUsername = async function () {
    const username = $("loginUsername").value.trim();
    const password = $("loginPassword").value;

    if (!username || !password) return setMsg("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");

    try {
      // Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„ÙŠÙˆØ²Ø±
      const q = query(collection(db, "users"), where("username", "==", username));
      const snap = await getDocs(q);
      if (snap.empty) return setMsg("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");

      // Ø®Ø° Ø£ÙˆÙ„ Ù†ØªÙŠØ¬Ø© (ÙŠÙØªØ±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ±ÙŠØ¯)
      const userDoc = snap.docs[0].data();
      const email = userDoc.email;
      if (!email) return setMsg("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");

      await signInWithEmailAndPassword(auth, email, password);
      setMsg("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…ØŒ ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„...", true);
      setTimeout(()=>{ window.location.href = "services.html"; }, 900);
    } catch (e) {
      setMsg(e.message || "ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
    }
  };

  // â™»ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (Ø¨Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø¨ÙŠÙˆØ²Ø± Ù„ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ Ø¥ÙŠÙ…ÙŠÙ„)
  window.resetPassword = async function () {
    const emailInput = $("resetEmail").value.trim();
    const usernameInput = $("resetUsername").value.trim();

    try {
      let email = emailInput;

      // Ø¥Ø°Ø§ Ù…Ø§ÙƒÙˆ Ø¥ÙŠÙ…ÙŠÙ„ Ù„ÙƒÙ† Ø¹Ù†Ø¯Ùƒ ÙŠÙˆØ²Ø±ØŒ Ø¬ÙŠØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ù† Firestore
      if (!email && usernameInput) {
        const q = query(collection(db, "users"), where("username", "==", usernameInput));
        const snap = await getDocs(q);
        if (snap.empty) return setMsg("Ù…Ø§ÙƒÙˆ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆØ²Ø±. Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¥Ø°Ø§ ØªØ°ÙƒÙ‘Ø±Ù‡.");
        email = snap.docs[0].data().email;
      }

      if (!email) return setMsg("Ø§ÙƒØªØ¨ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø§Ù„ÙŠÙˆØ²Ø± Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.");

      await sendPasswordResetEmail(auth, email);
      setMsg("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ âœ…", true);
    } catch (e) {
      setMsg(e.message || "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹.");
    }
  };
</script>
</body>
</html>
